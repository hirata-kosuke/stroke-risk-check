# Google Sheets 連携セットアップ手順

このガイドでは、React アプリから Google スプレッドシートへデータを自動送信する設定方法を説明します。

## 1. Google スプレッドシートの作成

1. [Google Sheets](https://sheets.google.com) にアクセス
2. 新規スプレッドシートを作成
3. シート名を「脳卒中リスクチェック_データ」などに変更

## 2. Google Apps Script のデプロイ

### 2-1. Apps Script エディタを開く

1. スプレッドシートで「拡張機能」→「Apps Script」をクリック
2. エディタが開きます

### 2-2. コードを貼り付け

1. エディタのデフォルトコード（`function myFunction() {...}`）を削除
2. `google-apps-script/Code.gs` の内容を全てコピー＆ペースト
3. 「💾 保存」をクリック（Ctrl+S）

### 2-3. デプロイ

1. エディタ右上の「デプロイ」→「新しいデプロイ」をクリック
2. 「種類の選択」→「ウェブアプリ」を選択
3. 設定:
   - **説明**: 「脳卒中リスクチェック API v1.0」
   - **次のユーザーとして実行**: 「自分」
   - **アクセスできるユーザー**: 「全員」
4. 「デプロイ」をクリック
5. 初回のみ、権限の承認が必要:
   - 「アクセスを承認」をクリック
   - Google アカウントを選択
   - 「詳細」→「（プロジェクト名）に移動」をクリック
   - 「許可」をクリック
6. **ウェブアプリのURL** が表示されます → コピー

例: `https://script.google.com/macros/s/AKfycbz.../exec`

## 3. React アプリの環境変数設定

### 3-1. .env ファイル作成

プロジェクトルートに `.env` ファイルを作成:

```bash
cd C:\Users\kawag\work\stroke-risk-check
copy .env.example .env
```

### 3-2. URL を設定

`.env` ファイルを開き、コピーした URL を設定:

```
VITE_GOOGLE_APPS_SCRIPT_URL=https://script.google.com/macros/s/AKfycbz.../exec
```

## 4. 動作確認

### 4-1. ローカルで確認

```bash
npm run dev
```

1. アプリを開く
2. リスクチェックを実行
3. 結果画面まで進む
4. Google スプレッドシートを開く
5. 「リスクチェックデータ」シートにデータが追加されているか確認

### 4-2. デプロイ後の確認

Vercel にデプロイする場合:

1. Vercel ダッシュボードで Environment Variables を設定
   - Key: `VITE_GOOGLE_APPS_SCRIPT_URL`
   - Value: Google Apps Script の URL
2. 再デプロイ
3. 本番環境でリスクチェックを実行
4. Google スプレッドシートでデータを確認

## 5. トラブルシューティング

### データが保存されない場合

1. **ブラウザの開発者ツール（F12）でエラーを確認**
   - Console タブでエラーメッセージを確認

2. **Google Apps Script のログを確認**
   - Apps Script エディタで「実行数」をクリック
   - エラーがあれば表示されます

3. **CORS エラーが出る場合**
   - 正常です（`mode: 'no-cors'` を使用しているため）
   - Google Sheets にデータが保存されていれば OK

4. **権限エラーが出る場合**
   - Apps Script のデプロイ設定を確認
   - 「アクセスできるユーザー」が「全員」になっているか確認

### Apps Script のコードを更新した場合

1. コードを編集
2. 「💾 保存」をクリック
3. 「デプロイ」→「デプロイを管理」
4. 既存のデプロイの「✏️ 編集」をクリック
5. 「バージョン」→「新バージョン」を選択
6. 「デプロイ」をクリック
7. URL は変わりません（同じ URL で新しいコードが動きます）

## 6. データ分析例

### ピボットテーブルでの集計

1. スプレッドシートで「挿入」→「ピボットテーブル」
2. 行: 「リスクレベル」
3. 値: 「名前」の個数
4. → リスクレベル別の人数が集計されます

### グラフ作成

1. データ範囲を選択
2. 「挿入」→「グラフ」
3. グラフの種類を選択:
   - 円グラフ: リスクレベル分布
   - 散布図: BMI vs 発症確率
   - 折れ線グラフ: 年齢別スコア

### フィルタと並べ替え

1. ヘッダー行を選択
2. 「データ」→「フィルタを作成」
3. 列ヘッダーの▼をクリック
4. 条件でフィルタ・並べ替え可能

## 7. セキュリティ注意事項

- スプレッドシートの共有設定に注意
  - 「限定公開」を推奨
  - 閲覧権限のみを付与
- Apps Script の URL は公開しないように
  - `.env` ファイルは `.gitignore` に追加済み
- 個人情報の取り扱いに注意
  - 名前は仮名・匿名化を推奨

## 完了

これで React アプリから Google スプレッドシートへのデータ送信が完了しました。

リスクチェックを実行するたびに、自動的にスプレッドシートにデータが追加されます。
